#include "ql_rtos.h"
#include "ql_power.h"
#include "ql_fs.h"

#include "general_include.h"
#include "lcd.h"

#include "font.h"

// #include "version.h"
#include "config.h"
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <stdio.h>

#if DEBUG_EN
#if DEBUG_TO_USB
#define _DEBUG(fmtString, ...) CPUartLogPrintf(fmtString, ##__VA_ARGS__)
#else
#define _DEBUG(fmtString, ...) printf(fmtString, ##__VA_ARGS__)
#endif
#else
#define _DEBUG(fmtString, ...)
#endif

QFILE *iFontFd;

typedef struct
{
	unsigned short usUnicode;
	unsigned char ucFont16Data[16];
	unsigned char ucFont12Data[12];
} stFontData;

stFontData iFontData[] =
	{
		{0x011f,
		 {
			 //0x00, 0x80, 0x48, 0x50, 0x50, 0xC8, 0x00, 0x00, 0x00, 0x27, 0x28, 0x28, 0x28, 0x1F, 0x00, 0x00
			 0x00, 0x80, 0xC8, 0x50, 0x50, 0xD8, 0xC0, 0x00, 0x00, 0x4F, 0x98, 0x90, 0x90, 0xD8, 0x7F, 0x00 // OK
		 },
		 {//0x00, 0x80, 0x58, 0x50, 0x58, 0xC0, 0x00, 0x03, 0x04, 0x04, 0x04//
		  0x00, 0xE0, 0x12, 0x14, 0x14, 0xF0, 0x00, 0x09, 0x0A, 0x0A, 0x0A, 0x07}},

		{0x011e,
		 {0xC0, 0x48, 0x30, 0x30, 0x28, 0x60, 0xC0, 0x00, 0x1F, 0x10, 0x20, 0x20, 0x22, 0x32, 0x3E, 0x00},
		 {0xF8, 0x09, 0x06, 0x06, 0x45, 0x4C, 0x03, 0x02, 0x04, 0x04, 0x04, 0x06}},

		{0x0131,
		 {
			 //0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x00, 0x00
			 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3F, 0x00, 0x00, 0x00, 0x00 // OK
		 },
		 {//0x00, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00//
		  0x00, 0x00, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00}},

		{0x0130,
		 {0x00, 0x00, 0x00, 0xF4, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x00, 0x00},
		 {0x00, 0x00, 0xFD, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00}},

		{0x00f6,
		 {0x00, 0x00, 0x18, 0x80, 0x98, 0x18, 0x00, 0x00, 0x00, 0x3E, 0x41, 0x40, 0x40, 0x41, 0x3E, 0x00},
		 {0x00, 0xC4, 0x20, 0x24, 0xC0, 0x00, 0x00, 0x03, 0x04, 0x04, 0x03, 0x00}},

		{0x00d6,
		 {0x00, 0xE0, 0x16, 0x10, 0x10, 0x16, 0xE0, 0x00, 0x00, 0x1F, 0x20, 0x40, 0x40, 0x20, 0x1F, 0x00},
		 {0xF8, 0x05, 0x02, 0x02, 0x0D, 0xF0, 0x07, 0x08, 0x08, 0x08, 0x04, 0x03}},

		{0x00fc,
		 {0x80, 0x20, 0x00, 0x00, 0x20, 0x80, 0x00, 0x00, 0x0F, 0x10, 0x10, 0x10, 0x08, 0x1F, 0x10, 0x00

		 },
		 {//0x00, 0xE8, 0x00, 0x00, 0x00, 0xE8, 0x00, 0x01, 0x02, 0x02, 0x01, 0x03
		  0x20, 0xE8, 0x00, 0x28, 0xE0, 0x00, 0x00, 0x03, 0x02, 0x02, 0x03, 0x00}},

		{0x00dc,
		 {0x00, 0xF0, 0x06, 0x00, 0x00, 0x06, 0xF0, 0x00, 0x00, 0x3F, 0x40, 0x40, 0x40, 0x40, 0x3F, 0x00},
		 {0xFC, 0x01, 0x00, 0x00, 0x01, 0xFC, 0x07, 0x08, 0x08, 0x08, 0x04, 0x03}},

		{0x015f,
		 {
			 //0x00, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x1B, 0x52, 0x76, 0x1D, 0x08, 0x00, 0x00
			 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x33, 0x26, 0x64, 0xA4, 0x3D, 0x08, 0x00 //OK
		 },
		 {
			 0x00, 0x40, 0xA0, 0xA0, 0x20, 0x00, 0x00, 0x02, 0x0A, 0x0E, 0x01 //
		 }},

		{0x015e,
		 {0x00, 0xC0, 0x60, 0x20, 0x20, 0x60, 0xC0, 0x00, 0x00, 0x19, 0x33, 0xA2, 0xE2, 0x22, 0x1C, 0x00},
		 {0x1C, 0x32, 0x22, 0x22, 0x66, 0x80, 0x03, 0x02, 0x0E, 0x0E, 0x03, 0x00}},

		{0x00e7,
		 {//0x00, 0xC0, 0x40, 0x20, 0x20, 0xC0, 0x00, 0x00, 0x00, 0x8F, 0xB0, 0x50, 0x10, 0x08, 0x04, 0x00//
		  0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x3F, 0xA0, 0xC0, 0x40, 0x21, 0x11, 0x00},
		 {
			 0x00, 0xC0, 0x20, 0x10, 0x10, 0x30, 0x00, 0x00, 0x03, 0x0E, 0x02 //
		 }},

		{0x00c7,
		 {0x00, 0xE0, 0x10, 0x08, 0x08, 0x08, 0x08, 0x30, 0x00, 0x0F, 0x18, 0x10, 0xE0, 0x20, 0x10, 0x08},
		 {
			 0xFE,
			 0x01,
			 0x01,
			 0x01,
			 0x01,
			 0x03,
			 0x00,
			 0x01,
			 0x02,
			 0x0E,
			 0x02,
			 0x01,
		 }},
};

void font_pkg_init(void)
{
	while (-1 == qfs_init('C', "ydwelink_char_fs", 0))
	{
		_DEBUG("Init C Disk faild!\r\n");
		ql_rtos_task_sleep_ms(2000);
	}

	iFontFd = ql_fopen(FONT_DZK_PATH, "r");

	if (iFontFd == NULL)
	{
		_DEBUG("Open font pkg faild!\r\n");
	}
}

//for some specel language letters
int font_get_data_ex(unsigned short usUnicode, enFontType iFont, unsigned char *pData)
{
	unsigned short usIdx, usSize;

	usSize = sizeof(iFontData) / sizeof(iFontData[0]);

	for (usIdx = 0; usIdx < usSize; usIdx++)
	{
		if (usUnicode == iFontData[usIdx].usUnicode)
		{
			if (iFont == PTT_FONT_TYPE_12)
			{
				memcpy(pData, iFontData[usIdx].ucFont12Data, 12);
			}
			else
			{
				memcpy(pData, iFontData[usIdx].ucFont16Data, 16);
			}
			usSize = 0;
			break;
		}
	}

	return usSize;
}

int font_get_data(unsigned short usUnicode, enFontType iFont, unsigned char *pData)
{
	unsigned int uiPos;
	int iRes = -1;

	if (usUnicode <= 0x007E)
	{
		if (iFont == PTT_FONT_TYPE_12)
		{
			uiPos = FONT_ASCII_12_BASE_ADD + (unsigned int)usUnicode * 12;
		}
		else
		{
			uiPos = FONT_ASCII_16_BASE_ADD + (unsigned int)usUnicode * 16;
		}

		ql_fseek(iFontFd, uiPos, 0);

		if (ql_fread(pData, 16, 1, iFontFd) > 0)
		{
			iRes = 0;
		}
	}
	else if (usUnicode >= 0x4e00)
	{
		if (iFont == PTT_FONT_TYPE_12)
		{
			uiPos = FONT_CHN_12_BASE_ADD + ((unsigned int)(usUnicode - 0x4e00)) * 24;
		}
		else
		{
			uiPos = FONT_CHN_16_BASE_ADD + ((unsigned int)(usUnicode - 0x4e00)) * 32;
		}
		ql_fseek(iFontFd, uiPos, 0);

		if (ql_fread(pData, 32, 1, iFontFd) > 0)
		{
			iRes = 0;
		}
	}

	return iRes;
}

int font_get_16_bmp(unsigned short usUnicode, unsigned char *pBuf)
{
	signed char i;
	unsigned short j = 0, k = 0;
	unsigned int uiPos;
	unsigned char ucBit[32];

	if (usUnicode < 0x4e00 && usUnicode > 0x007F)
		return -1;

	if (usUnicode <= 0x007F)
	{
		uiPos = usUnicode;
		ql_fseek(iFontFd, uiPos * 16, 0);
	}
	else
	{
		uiPos = (usUnicode - 0x4e00) + 0x80 * 16;
	}

	ql_fseek(iFontFd, uiPos * 32, 0);

	if (ql_fread(ucBit, 32, 1, iFontFd) > 0)
	{
		for (j = 0; j < 32; j++)
		{
			//printf("%02X ", ucBit[j]);
			for (i = 7; i >= 0; i--)
			{
				if (ucBit[j] & (1 << i))
				{
					pBuf[k++] = 0x00;
					pBuf[k++] = 0x00;
					//_DEBUG("FFFF ");
				}
				else
				{
					pBuf[k++] = 0xff;
					pBuf[k++] = 0xff;
					//_DEBUG("0000 ");
				}
			}
		}
	}
	else
	{
		_DEBUG("Read Bmp Fild!\r\n");
	}

	return 0;
}

int font_display_test(unsigned short usUnicode)
{
	unsigned char ucBmp[512];

	memset(ucBmp, 0, sizeof(ucBmp));

	font_get_16_bmp(usUnicode, ucBmp);

	lcd_draw_bmp(20, 20, 15, 17, ucBmp);

	return 0;
}
